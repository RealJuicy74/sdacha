import socket
import queue
import threading
from cryptography.fernet import Fernet
import getpass
import socket, threading, time
from pyzbar import pyzbar
import cv2
import re


#Подключение к серверу
PORT = 5050
DISCONNECT_MESSAGE = "END"
SEND_FILE_MESSAGE = 'Send file'
SERVER = "192.168.0.6"
ADDR = (SERVER, PORT)

client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(ADDR)

shutdown = False
#Рисование баркода
def draw_barcode(decoded, image):
    # n_points = len(decoded.polygon)
    # for i in range(n_points):
    #     image = cv2.line(image, decoded.polygon[i], decoded.polygon[(i+1) % n_points], color=(0, 255, 0), thickness=5)
    image = cv2.rectangle(image, (decoded.rect.left, decoded.rect.top),(decoded.rect.left + decoded.rect.width, decoded.rect.top + decoded.rect.height),color=(0, 255, 0), thickness=5)
    return image

#декодирование
def decode(image):
    # decodes all barcodes from an image
    decoded_objects = pyzbar.decode(image)
    for obj in decoded_objects:
        # draw the barcode
        image = draw_barcode(obj, image)
        # print barcode type & data
        print("Type:", obj.type)
        print("Data:", obj.data)
        print()
    return image



def receving(name, sock):
    while not shutdown:
        try:
            while True:
                data, addr = sock.recvfrom(1024)
                print(data.decode("utf-8"))
                time.sleep(0.001)
        except:
            pass

#Ключ
def load_key():
    a = open('crypto.key', 'rb').read()
    return a


#Шифрование файла
def encrypt(filename, key):
    f = Fernet(key)
    with open(filename, 'rb') as file:
        file_data = file.read()
        encrypted_data = f.encrypt(file_data)
    with open(filename, 'wb') as file:
        file.write(encrypted_data)


#Дешифрование файла
def decrypt(filename, key):
    f = Fernet(key)
    with open(filename, 'rb') as file:
        encrypted_data = file.read()
    decrypted_data = f.decrypt(encrypted_data)
    with open(filename, 'wb') as file:
        file.write(decrypted_data)


#Отправление сообщений
def send(msg):
    f = Fernet(load_key())
    try:
        encrypted_msg = f.encrypt(msg.encode('utf8'))
        client.send(encrypted_msg)
    except:
        encrypted_msg = f.encrypt(msg)
        client.send(encrypted_msg)


#Прием сообщений
def reciver(conn, q):
    f = Fernet(load_key())
    if q == 1:
        encrypted_msg = conn.recv(5335800)
        decrypted_msg = f.decrypt(encrypted_msg)
        decrypted_msg = decrypted_msg.decode('utf8')
        print(decrypted_msg)
    else:
        while not shutdown:
            try:
                encrypted_msg = conn.recv(5335800)
                decrypted_msg = f.decrypt(encrypted_msg)
                decrypted_msg = decrypted_msg.decode('utf8')
                if decrypted_msg:
                    if decrypted_msg == '--Lovi File--':
                        encrypted_name = client.recv(1024)
                        decrypted_name = f.decrypt(encrypted_name)
                        name = decrypted_name.decode('utf8')
                        encrypted_data = client.recv(5335800)
                        decrypted_data = f.decrypt(encrypted_data)
                        data = decrypted_data
                        if type(data) == bytes:
                            with open(f'Filiki/{name}', 'wb') as file:
                                file.write(data)
                        else:
                            with open(f'Filiki/{name}', 'w') as file:
                                file.write(data)
                        print('Файл успешно установлен.\n')
                    else:
                        q.put((conn, decrypted_msg))
                        print(decrypted_msg)
            except:
                break


#Запуск клиентского приложения
# Определить флаг для завершения работы программы
flag = True
 
 # Сохраните информацию QR-кода в базе данных MySQL
def insert(type, data):
 
         # Определить глобальные переменные
    global flag
 
         # Создать объект подключения к базе данных

    host = socket.gethostbyname(socket.gethostname())
    port = 5432
    hostt = '127.0.0.1'
    userr = 'postgres'
    passwordd = 'zandon2000'
    db_namee = 'tovar'

    conn = PostgresqlDatabase(db_namee, user = userr, password = passwordd, host = hostt)
                 # Метод кодирования базы данных - utf8
    charset="utf8"
    
 
         # Используйте курсор () метод для создания курсора объекта курсора
    cursor = conn.cursor()
 
         # Оператор вставки SQL
    sql = "insert into qrcode(type,data) values(%s,%s)"
    try:
                 # Выполнить инструкцию sql
        if cursor.execute(sql, (type, data)) != -1:
            flag = False
                 # Отправить в базу данных для исполнения
        conn.commit()
    except Exception as e:
                 # Если возникает ошибка, откатитесь и распечатайте сообщение об ошибке
        conn.rollback()
        print(e)
 
         # Закрыть курсор
    cursor.close()
         # Закрыть соединение с базой данных
    conn.close()
 
 
 # Анализировать QR-код
def decode(image):
         # Разобрать изображение
    barcodes = pyzbar.decode(image)
 
    for barcode in barcodes:
                 # Извлечь положение ограничительной рамки QR-кода
        (x, y, w, h) = barcode.rect
                 # Нарисуйте ограничительную рамку штрих-кода на изображении
        cv2.rectangle(image, (x, y), (x + w, y + h), (0, 0, 255), 2)
 
                 # Тип QR-кода
        barcodeType = barcode.type
                 # QR код данных
        barcodeData = barcode.data.decode("utf-8")
 
                 # Хранить информацию в базе данных
        insert(barcodeType, barcodeData)
 
                 # Нарисуйте тип QR-кода и данные QR-кода на изображении
        text = "{} ".format(barcodeType, barcodeData)
        cv2.putText(image, text, (x, y - 10), cv2.FONT_HERSHEY_SIMPLEX,
                    .5, (0, 0, 125), 2)
 
                 # Печать данных штрих-кода и типа штрих-кода на терминал
        print("[INFO] Found {} barcode: {}".format(barcodeType, barcodeData))
 
    return image
 
 
 # Позвоните в камеру, чтобы распознать QR-код
def detect():
         # Позвоните на встроенную камеру
    camera = cv2.VideoCapture (0) # Параметр 0 представляет встроенную камеру, параметр 1 представляет внешнюю камеру
 
         # Отображение изображений в реальном времени
    while flag:
                 # Читать текущий кадр
        ret, frame = camera.read () # ret: логическое значение, указывающее, следует ли открывать камеру обычным образом: получить текущее изображение кадра
                 # Преобразовать в изображение в градациях серого
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
                 # Вызов аналитической функции
        img = decode(gray)
 
                 # Нажмите Q, чтобы выйти из программы
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break
 
                 # Показать изображение
        cv2.imshow("camera", img)
 
         # Освободить ресурсы камеры
    camera.release()
         # Закройте окно с изображением
    cv2.destroyAllWindows()
 
 
 # Запись основной функции
if __name__ == '__main__':
    detect()
